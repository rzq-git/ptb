<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photobooth</title>
  <style>
    .container {
      position: relative;
      width: 640px;
      height: 640px;
      margin: 20px auto;
    }
    #video, #frame {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #video {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    #frame {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      pointer-events: none;
    }
    #canvas {
      display: none;
    }
    #preview {
      display: none;
      margin: 20px auto;
      width: 640px;
      height: 640px;
    }
    .buttons {
      text-align: center;
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <video id="video" autoplay></video>
    <img id="frame" src="frame.png" alt="Frame">
  </div>
  <canvas id="canvas" width="640" height="640"></canvas>
  <img id="preview" alt="Captured Photo">
  <div class="buttons">
    <button id="capture">Capture</button>
    <button id="save" disabled>Save</button>
    <button id="print" disabled>Print</button>
    <button id="refresh">Refresh</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const frameImg = document.getElementById('frame');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const captureButton = document.getElementById('capture');
    const saveButton = document.getElementById('save');
    const printButton = document.getElementById('print');
    const refreshButton = document.getElementById('refresh');

    let frameLoaded = false;

    // Akses kamera
    navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 640 },
        height: { ideal: 640 },
        aspectRatio: { ideal: 1 }
      }
    })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          console.log('Video sedang berjalan');
        };
      })
      .catch(err => {
        console.error('Gagal akses kamera: ', err);
        alert('Gagal mengakses kamera. Pastikan izin diberikan.');
      });

    // Pastikan frame di-load
    frameImg.onload = () => {
      frameLoaded = true;
      console.log('Frame berhasil di-load');
    };
    frameImg.onerror = () => {
      console.error('Gagal memuat frame.png');
      alert('File frame.png tidak ditemukan atau gagal dimuat.');
    };

    // Capture foto dengan frame
    captureButton.addEventListener('click', () => {
      console.log('Tombol capture ditekan');
      if (!video.srcObject) {
        alert('Kamera belum siap. Pastikan akses kamera berhasil.');
        return;
      }
      if (!frameLoaded) {
        alert('Frame belum terload, tunggu sebentar atau pastikan file frame.png ada.');
        return;
      }
      const context = canvas.getContext('2d');
      if (!context) {
        console.error('Gagal mendapatkan context canvas');
        return;
      }
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      context.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL('image/png');
      preview.src = dataURL;
      preview.style.display = 'block';
      saveButton.disabled = false;
      printButton.disabled = false;
      console.log('Foto berhasil di-capture');
    });

    // Save foto
    saveButton.addEventListener('click', () => {
      console.log('Tombol save ditekan');
      const dataURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = 'foto-photobooth.png';
      link.click();
    });

    // Print foto
    printButton.addEventListener('click', () => {
      console.log('Tombol print ditekan');
      const dataURL = canvas.toDataURL('image/png');
      const printWindow = window.open('', '', 'width=800,height=800');
      printWindow.document.write('<img src="' + dataURL + '" style="width:100%;height:auto;" />');
      printWindow.document.close();
      printWindow.print();
    });

    // Refresh
    refreshButton.addEventListener('click', () => {
      console.log('Tombol refresh ditekan');
      preview.style.display = 'none';
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);
      saveButton.disabled = true;
      printButton.disabled = true;
    });
  </script>
</body>
</html>